name: build
on:
    # run on push but only for the develop and release branches
    push:
        branches:
            - develop
            - release
    # run for every pull request
    pull_request: {}
jobs:
    main:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node: [12]
        steps:
            - name: Checkout repo
              uses: actions/checkout@v2

            - name: Setup node
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node }}

            - name: ðŸ“¥ Download deps
              uses: bahmutov/npm-install@v1
              with:
                  useLockFile: false

            - name: Set domain
              run: echo "127.0.0.1 localhost.paypal.com" | sudo tee -a /etc/hosts

            - name: Lint
              run: |
                  npm run lint

            - name: Unit Tests
              run: |
                  npm run test

            - name: Run server
              run: |
                  ((npm run dev:standalone 2>&1 & echo $! > pid.log) | tee server.log) &
                  sleep 40
                  error_count=$(grep -i error server.log | wc -l)
                  echo "Errors Found: $error_count"
                  if [[ $error_count -gt 0 ]]; then
                    echo "Exiting server"
                    kill $(<pid.log)
                    exit 1
                  fi

            - name: Functional Non-Snapshot Tests
              run: |
                  npm run test:func:nosnaps

    lighthouse:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2

        - name: Setup node
          uses: actions/setup-node@v1
          with:
              node-version: ${{ matrix.node }}

        - name: ðŸ“¥ Download deps
          uses: bahmutov/npm-install@v1
          with:
              useLockFile: false

        - name: Desktop Audit URLs using Lighthouse
          id: LHCIActionDesktop
          uses: treosh/lighthouse-ci-action@v8
          env: 
            SUPER_SECRET: ${{ secrets.LIGHTHOUSE_HOME }}
          with:
            runs: 4
            configPath: tools/performance/lighthouserc-desktop.js
            uploadArtifacts: true # save results as an action artifacts
            temporaryPublicStorage: true # upload lighthouse report to the temporary storage

        - name: Mobile Audit URLs using Lighthouse
          id: LHCIActionMobile
          uses: treosh/lighthouse-ci-action@v8
          env: 
            SUPER_SECRET: ${{ secrets.LIGHTHOUSE_HOME }}
          with:
            runs: 4
            configPath: tools/performance/lighthouserc-mobile.js
            uploadArtifacts: true # save results as an action artifacts
            temporaryPublicStorage: true # upload lighthouse report to the temporary storage

        - name: Performance Benchmark
          if: "startsWith(github.event.head_commit.message, 'WIP')"
          run: |
              TEST_DESKTOP=${{steps.LHCIActionDesktop.outputs.manifest}} TEST_MOBILE=${{steps.LHCIActionMobile.outputs.manifest}} npm run benchmark